<!--#4DSCRIPT/webRedirectIfNotAuthorized-->

<!--PQ GRID LOADGRID -->
<script type="text/javascript">
    function loadGrid(theTable) {

        var wapi_filter = '';
        console.trace();

        <!--#4DSCRIPT/WAPI_4DInclude/app/pq/include/pq_gettablename.js-->
        <!--#4DSCRIPT/WAPI_4DInclude/app/pq/include/pq_commentRender.js--> 

        //--------- INITIALIZATION FUNCTION -----------
        <!--#4DSCRIPT/WAPI_4DInclude/app/pq/include/pq_initGrid.js-->


        //--------- DEFINE GRID OBJECT -----------
        //          NOTE: grid object var = obj
        var obj = {
            //create grid with defaults
            <!--#4DSCRIPT/WAPI_4DInclude/app/pq/include/pq_createGrid.js--> 
            //set override - additional options
            height: "100%",
            showTitle: false,
            rowHt: 35,
        };

        switch (theTable) {

            case 'ewires':

                //--------------- DEFINE COLUMN MODEL -------------------
                obj.colModel = [

                    // ADD COLUMNS TO THE GRID HERE -- USE 4D TABLENAME___FIELDNAME 
                    // THE FIRST COLUMN SHOULD BE THE PK/ID FIELD FOR THE TABLE - YOU CAN SET HIDDEN:TRUE
                    // https://paramquery.com/pro/api#option-colModel <-- doc's and options


                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___ewireid, filter:false, hidden:true} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___ewireid,title:eWire-ID, filter:false, maxWidth:150} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___senddate, title:Date ,filter:true, align:center, maxWidth:100} -->,   			
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___ewirestatus, title:Status, filter:false, maxWidth:125} -->,

                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___beneficiaryFullName,title:Beneficiary, filter:true, width:150} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___fromCountryCode,title:From, filter:true, maxWidth:60} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___fromAmount,title:From-Amt, format:currency, filter:false} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___toCountryCode,title:To, filter:true, maxWidth:60} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___toAmount,title:To-Amt, format:currency, filter:false} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:ewires___currency,title:CCY, filter:false, maxWidth:50} -->,

                ];

                // ------------- DEFINE DATAMODEL -----------
                obj.dataModel = {
                    <!--#4DSCRIPT/WAPI_4DInclude/app/pq/include/pq_dataModel.js--> 
                };


                //--------------DEFINE SORTMODEL -------------
                obj.sortModel = {
                    <!--#4DSCRIPT/WAPI_4DInclude/app/pq/include/pq_sortModel.js-->

                    type: 'remote',
                    sorter: [{
                        dataIndx: 'ewires___toCountry',
                        dir: 'up'
                    }],
                };


                obj.filterModel = {
                    header: true,
                    on: true,
                    type: 'remote',
                    menuIcon: true,
                };

                obj.menuUI = {
                    singleFilter: true,
                };



                //--------------DEFINE GROUP MODEL -------------
                // NONE


                obj.rowDblClick = function(evt, ui) {

                    var id = ui.rowData.ewires___ewireid;
                    var name = ui.rowData.ewires___beneficiaryfullname;

                    var viewForm = new FormData();

                    viewForm.append('ewires___ewireid', id);
                    viewForm.append('table', 'ewires');
                    viewForm.append('primarykey', 'ewires___ewireid');
                    viewForm.append('action', 'view');
                    viewForm.append('readonly', 'true');
                    viewForm.append('form-post', 'agents/ewires-dialog.shtml');

                    var request = new XMLHttpRequest();

                    request.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            $('#dialog-ewires-body').html(request.responseText) //inject the response page into the dialog div                    
                            $('#dialog-ewires').modal('show'); //bootstrap                    
                        }

                    };

                    request.responseType = 'text';
                    request.open('POST', 'postPage');
                    request.send(viewForm);
                    request.response
                };

                obj.rowSelect = function(evt, ui) {

                    var row = ui.addList[0];
                    var id = row.rowData.ewires___ewireid;
                    var name = row.rowData.ewires___beneficiaryfullname;
                    var amt = row.rowData.ewires___toamount;

                    $("#ewire-cancel-button").val('Cancel the eWire for  ' + name + ' in the amount of ' + amt);
                    $('#wapi-confirm-message').html('Are you sure you want to cancel the eWire for  ' + name + ' in the amount of ' + amt);
                    $("#ewire-cancel-button").removeAttr('disabled');
                    $("[id=ewires___ewireid]").val(id);
                    $("[id=ewires___iscancelled]").val('true');
                    //alert(str)
                };

                //---------- INSERT THE GRID INTO THE DOM ---------------
                var historyGrid = pq.grid("div#history-grid", obj);

                break;



            case 'links':

                //--------------- DEFINE COLUMN MODEL -------------------
                obj.colModel = [
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:links___linkid, filter:false, hidden:true} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:links___aml_isonhold, title:On-Hold, filter:false, hidden:false} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:links___customerid, title:Client-Num, filter:true, hidden:false, width:110} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:links___customername, title:Client-Name ,filter:true, width:160} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:links___customerphone,title:Phone, filter:true, width:120} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:customers___countrycode,title:Country, filter:false, maxWidth:100} -->,
                    <!--#4DSCRIPT/WAPI_getColModelColumn/{field:customers___email,title:Email, filter:false} -->,


                ];

                // ------------- DEFINE DATAMODEL -----------
                obj.dataModel = {
                    <!--#4DSCRIPT/WAPI_4DInclude/app/pq/include/pq_dataModel.js--> 
                };

                obj.rowSelect = function(evt, ui) {

                    var row = ui.addList[0];
                    var id = row.rowData.links___linkid;
                    var name = row.rowData.links___customername;
                    var custid = row.rowData.links___customerid;

                    $("#links-send-ewire").val('Send eWire to  ' + name);
                    $("#links-send-ewire").removeAttr('disabled');
                    $("[id=ewires-linkid-input]").val(id);
                    $("[id=ewires-customerid-input]").val(custid);
                    //alert(str)
                };

                //---------- INSERT THE GRID INTO THE DOM ---------------
                var beneficiaryGrid = pq.grid("div#beneficiary-grid", obj);


                break;


        };

    };

</script>

<!-- ON READY -->
<script type="text/javascript">
    $(function() {
        // ADD ON SHOW ACCORDIAN EVENT HERE -----         
        $('#history-data').on('show.bs.collapse', function() {
            loadGrid('ewires');
        });

        $('#beneficiary-data').on('show.bs.collapse', function() {
            loadGrid('links');
        });
    });

</script>


<div class="panel-group" id="accordion" role="tablist" aria-multiselectable='true'>

    <!-- COUNTERPARTY NAME INFO -->
    <div class="panel panel-default">

        <div class="panel-heading" role="tab" id="name-tab">
            <h3 class="panel-title">
                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#name-data" aria-expanded="false" aria-controls="name-data">
                    <span class="glyphicon glyphicon-user" aria-hidden="true"> </span> Client Details</a>
            </h3>
        </div>

        <div id="name-data" class="panel-collapse collapse" role="tabpanel" aria-labelledby="name-tab">
            <div class="panel-body">
                <form enctype="multipart/form-data" id='links-form-name' action="updateMethod" method="post">

                    <!--#4DSCRIPT/WAPI_formHeader/{table:links, primarykey:links___linkid}-->

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___salutation, label:Salutation, onchange:wapiObjectMethod, placeholder:Salutation, width:100px, choicelist:titles, readonly:true-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___firstname, label:First-Name, placeholder:First-name-of-counterparty, readonly:true}}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___lastname, label:Last-Name, placeholder:Last-name-of-counterparty, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___gender, label:Gender, placeholder:Gender, choicelist:webgetchoicelistgender, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___dob, label:Date-of-birth, placeholder:Date-of-birth, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___aml_isonhold, label:AML-On-Hold, readonly:true}-->
                    </div>
                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___aml_onholdnotes, label:AML-On-Hold-Readon, readonly:true}-->
                    </div>

                    <div class='form-group'>
                        <!--#4DSCRIPT/WAPI_formGroup_xhrBtns/{module:name, form:links-form-name, collapse:name-data}-->
                    </div>

                </form>
            </div>


        </div>

    </div>


    <!-- COUNTERPARTY DEMOGRAPHICS INFO -->
    <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="demographics-tab">
            <h3 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#demographic-data" aria-expanded="false" aria-controls="demographic-data">
                    <span class="glyphicon glyphicon-home" aria-hidden="true"></span> Contact Info</a>
            </h3>
        </div>

        <div id="demographic-data" class="panel-collapse collapse" role="tabpanel" aria-labelledby="demographics-tab">
            <div class="panel-body">
                <form enctype="multipart/form-data" id='links-form-demographics' action="updateMethod" method="post">

                    <!--#4DSCRIPT/WAPI_formHeader/{table:links, primarykey:links___linkid}-->

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___occupation, label:Occupation, placeholder:Occupation-of-counterparty, width:100, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___relationship, label:Relationship, placeholder:Relationship-to-customer, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___companyname, label:Company-Name, placeholder:Company-name-<OPTONAL>, width:100, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___country, label:Country, placeholder:Country-of-residence, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___city, label:City/Province-or-State, placeholder:City-and-province-state-of-residence, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___address, label:Address, placeholder:Address-of-residence, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___email, label:Email, placeholder:Email-address, width:100, inputmask-alias:email, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___mainphone, label:Main-Phone, placeholder:Primary-phone-of-customer, inputmask-mask:999-999-9999, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___nationality, label:Nationality, placeholder:Nationality-of-customer, width:100, readonly:true}-->
                    </div>

                    <div class='form-group'>
                        <!--#4DSCRIPT/WAPI_formGroup_xhrBtns/{module:demographics, form:links-form-demographics, collapse:demographic-data}-->
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- COUNTERPARTY PICTURE ID INFO -->
    <div class="panel panel-default">

        <div class="panel-heading" role="tab" id="picture-tab">
            <h3 class="panel-title">
                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#picture-data" aria-expanded="false" aria-controls="picture-data">
                    <span class="glyphicon glyphicon-picture" aria-hidden="true"></span> Picture ID</a>
            </h3>
        </div>

        <div id="picture-data" class="panel-collapse collapse" role="tabpanel" aria-labelledby="picture-tab">
            <div class="panel-body">

                <form enctype="multipart/form-data" id='links-form-picture' action="wapi_xhraction" method="post">

                    <!--#4DSCRIPT/WAPI_formHeader/{table:links, primarykey:links___linkid}-->

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___pictureidtype, label:Government-ID-Type, placeholder:ie.-license-passport, width:100, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___pictureidno, label:Government-ID-No, placeholder:ID-Number-Assigned-To-ID, width:100, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___pictureidissuedin, label:Country-of-Issue, placeholder:Country-issuing-your-ID, width:100, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___pictureidexpdate, label:Expiry-Date, readonly:true}-->
                    </div>

                    <!--#4DIF false-->
                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___pictureid, label:Image-of-Picture-ID, placeholder:Picture-ID, readonly:false, image-width:200, image-compression:.5, image-upload:true}-->
                    </div>
                    <!--#4DENDIF-->

                    <!-- DROPZONE AREA FOR ADDITIONAL ATTACHMENTS -->
                    <div class="row" id="wapi-dropzone-group">
                        <div class="dz-clickable dropzone-previews" id="wapi-dropzone">
                            <div class="dz-message text-center" style="padding-bottom: 12px">
                                <h3><span class="label label-default">Click or Drop Files Here to Attach</span></h3>
                            </div>
                        </div>

                        <div class="form-group fallback">
                            <input id='dropzone-upload-file' type="file" multiple />
                        </div>
                    </div>

                    <!-- PREVIOUSLY SUBMITTED ATTACHMENTS -->
                    <!--#4DSCRIPT/webSelectRelatedWebAttachments/[links]-->

                    <div class="well">
                        <div class="row row-eq-height">
                            <!--#4DLOOP [WebAttachments]-->
                            <div class="col-sm-3">
                                <!--#4DSCRIPT/wapi_formMediaGroup/{field-preview:webattachments___preview, field-id:webattachments___uuid, field-path:webattachments___filepath, field-description:webattachments___description, field-name:webattachments___filename, field-mimetype:webattachments___mimetype, readonly:true}-->
                            </div>
                            <!--#4DENDLOOP-->

                        </div>
                    </div>
                    <div class="text-centered">*Previously submitted attachments</div>


                    <!--#4DIF false-->
                    <div class="form-group">
                        <!--    video stream test -->
                        <video width=320 height=240 id="player" controls autoplay></video>
                        <input type="button" id="capture" value="Capture">
                        <canvas id="canvas" width=320 height=240></canvas>
                        <script>
                            const player = document.getElementById('player');
                        const canvas = document.getElementById('canvas');
                        const context = canvas.getContext('2d');
                        const captureButton = document.getElementById('capture');

                        const constraints = {
                            video: true,
                        };

                        captureButton.addEventListener('click', () => {
                            context.drawImage(player, 0, 0, canvas.width, canvas.height);

                            // Stop all video streams.
                            player.srcObject.getVideoTracks().forEach(track => track.stop());
                        });

                        navigator.mediaDevices.getUserMedia(constraints)
                            .then((stream) => {
                                // Attach the video stream to the video element and autoplay.
                                player.srcObject = stream;
                            });

                    </script>

                    </div>
                    <!--#4DENDIF-->

                    <div class='form-group'>
                        <!--#4DSCRIPT/WAPI_formGroup_xhrBtns/{module:picture, form:links-form-picture, collapse:picture-data}-->
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- COUNTERPARTY BANKING INFO -->
    <div class="panel panel-default">

        <div class="panel-heading" role="tab" id="banking-tab">
            <h3 class="panel-title">
                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#banking-data" aria-expanded="false" aria-controls="banking-data">
                    <span class="glyphicon glyphicon-usd" aria-hidden="true"></span> Financial Information</a>
            </h3>
        </div>

        <div id="banking-data" class="panel-collapse collapse" role="tabpanel" aria-labelledby="banking-tab">
            <div class="panel-body">

                <form enctype="multipart/form-data" id='links-form-banking' action="updateMethod" method="post">

                    <!--#4DSCRIPT/WAPI_formHeader/{table:links, primarykey:links___linkid}-->

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___bankname, label:Bank-Name, placeholder:Bank-name, width:100, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___bankaccountno, label:Account-Number, placeholder:Bank-account-number, width:100, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___banktransitcode, label:Transit-Number, placeholder:SWIFT-BIC-Transit-numbers, width:100, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___bankaddress, label:Bank Address, placeholder:Bank-address, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___bankingdetails, label:Banking-Details, placeholder:Bank-details, readonly:true}-->
                    </div>

                    <div class="form-group">
                        <!--#4DSCRIPT/WAPI_formGroup/{field:links___defaultpurposeoftransaction, label:Usual-Purpose-Of-Your-Transactions, placeholder:Usual-purpose-of-transactions, readonly:true}-->
                    </div>

                    <div class='form-group'>
                        <!--#4DSCRIPT/WAPI_formGroup_xhrBtns/{module:banking, form:links-form-banking, collapse:banking-data}-->
                    </div>

                </form>

            </div>
        </div>
    </div>


    <!-- BENEFICIARIES -- CUSTOMERS -->
    <!--4DIF (true)-->
    <div class="panel panel-default">

        <div class="panel-heading" role="tab" id="beneficiary-tab">
            <h3 class="panel-title">
                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#beneficiary-data" aria-expanded="true" aria-controls="beneficiary-data">
                    <span class="glyphicon glyphicon-user" aria-hidden="true"> </span> Beneficiaries</a>
            </h3>
        </div>

        <div id="beneficiary-data" class="panel-collapse collapse" role="tabpanel" aria-labelledby="beneficiary-tab">
            <div class="panel-body">
                <div class='form-group' style='height: 300px'>
                    <div id="beneficiary-grid"></div><!-- INSERT beneficiary GRID HERE -->
                </div>

                <div class='form-group'>
                    <!--4DIF (false)-->
                    <input type="submit" class="btn btn-primary" id="links-create-link" name="links-create-link" value="Create Beneficiary">
                    <!--#4DENDIF-->

                    <div class="pull-right">
                        <form enctype="multipart/form-data" id='ewire-send-form' action="postPage" method="post">
                            <!--#4DSCRIPT/WAPI_formHeader/{table:ewires, action:create, post:agents/ewires-create.shtml}-->
                            <input type="hidden" id="ewires-linkid-input" name="ewires-linkid-input" value="">
                            <input type="hidden" id="ewires-customerid-input" name="ewires-customerid-input" value="">
                            <input type="submit" class="btn btn-primary" id="links-send-ewire" name="links-send-ewire" disabled value="Send eWire">
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!--4DENDIF-->


    <!-- CLIENT EWIRE HISTORY -->
    <!--4DIF (TRUE)-->
    <div class="panel panel-default">

        <div class="panel-heading" role="tab" id="history-tab">
            <h3 class="panel-title">
                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#history-data" aria-expanded="true" aria-controls="history-data">
                    <span class="glyphicon glyphicon-usd" aria-hidden="true"> </span> eWire History</a>
            </h3>
        </div>

        <div id="history-data" class="panel-collapse collapse" role="tabpanel" aria-labelledby="history-tab">
            <div class="panel-body">
                <div class='form-group' style='height: 300px'>
                    <div id="history-grid"></div><!-- INSERT HISTORY GRID HERE -->
                </div>

            </div>
        </div>
    </div>
    <!--4DENDIF-->


    <!-- COUNTERPARTY CUSTOMER INFO -->
    <!--4DIF (false)-->
    <div class="panel panel-default">

        <div class="panel-heading" role="tab" id="customer-tab">
            <h3 class="panel-title">
                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#customer-data" aria-expanded="true" aria-controls="customer-data">
                    <span class="glyphicon glyphicon-user" aria-hidden="true"> </span> Receiving Party</a>
            </h3>
        </div>

        <div id="customer-data" class="panel-collapse collapse" role="tabpanel" aria-labelledby="customer-tab">
            <div class="panel-body">
                <div class="form-group">
                    <!--#4DSCRIPT/WAPI_formGroup/{field:links___customerid, label:Customer-ID, readonly:true, onchange:wapiObjectMethod, placeholder:ID, width:100px -->
                </div>

                <div class="form-group">
                    <!--#4DSCRIPT/WAPI_formGroup/{field:links___customername, label:Name, placeholder:Name-of-customer, width:100px, readonly:true}-->
                </div>

                <!--4DIF (false)-->
                <!-- add privacy key/value option -->
                <div class="form-group">
                    <!--#4DSCRIPT/WAPI_formGroup/{field:links___customerphone, label:Phone, placeholder:Phone, readonly:true}-->
                </div>

                <div class="form-group">
                    <!--#4DSCRIPT/WAPI_formGroup/{field:links___customerbankinfo, label:Bank-Info, placeholder:Banking-information, readonly:true}-->
                </div>
                <!--4DENDIF-->

            </div>
        </div>
    </div>
    <!--4DENDIF-->
</div>
